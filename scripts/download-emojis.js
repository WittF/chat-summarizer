const fs = require('fs')
const path = require('path')
const https = require('https')

// 常用emoji映射表
const emojiMap = {
  '🤖': '1f916',
  '😀': '1f600',
  '😃': '1f603',
  '😄': '1f604',
  '😁': '1f601',
  '😆': '1f606',
  '😅': '1f605',
  '😂': '1f602',
  '🤣': '1f923',
  '😊': '1f60a',
  '🙂': '1f642',
  '😉': '1f609',
  '😍': '1f60d',
  '🥰': '1f970',
  '😘': '1f618',
  '😋': '1f60b',
  '😛': '1f61b',
  '😝': '1f61d',
  '😜': '1f61c',
  '🤪': '1f929',
  '🤨': '1f928',
  '🧐': '1f9d0',
  '🤓': '1f913',
  '😎': '1f60e',
  '🤩': '1f929',
  '🥳': '1f973',
  '😏': '1f60f',
  '😒': '1f612',
  '😞': '1f61e',
  '😔': '1f614',
  '😟': '1f61f',
  '😕': '1f615',
  '🙁': '1f641',
  '😣': '1f623',
  '😖': '1f616',
  '😫': '1f62b',
  '😩': '1f629',
  '🥺': '1f97a',
  '😢': '1f622',
  '😭': '1f62d',
  '😤': '1f624',
  '😠': '1f620',
  '😡': '1f621',
  '🤬': '1f92c',
  '🤯': '1f92f',
  '😱': '1f631',
  '😨': '1f628',
  '😰': '1f630',
  '😥': '1f625',
  '😓': '1f613',
  '🤗': '1f917',
  '🤔': '1f914',
  '🤭': '1f92d',
  '🤫': '1f92b',
  '🤥': '1f925',
  '😶': '1f636',
  '😐': '1f610',
  '😑': '1f611',
  '😬': '1f62c',
  '🙄': '1f644',
  '😯': '1f62f',
  '😦': '1f626',
  '😧': '1f627',
  '😮': '1f62e',
  '😲': '1f632',
  '🥱': '1f971',
  '😴': '1f634',
  '🤤': '1f924',
  '😪': '1f62a',
  '😵': '1f635',
  '🤐': '1f910',
  '🥴': '1f974',
  '🤢': '1f922',
  '🤮': '1f92e',
  '🤧': '1f927',
  '😷': '1f637',
  '🤒': '1f912',
  '🤕': '1f915',
  '🤑': '1f911',
  '🤠': '1f920',
  '😈': '1f608',
  '👿': '1f47f',
  '👹': '1f479',
  '👺': '1f47a',
  '🤡': '1f921',
  '💩': '1f4a9',
  '👻': '1f47b',
  '💀': '1f480',
  '☠️': '2620-fe0f',
  '👽': '1f47d',
  '👾': '1f47e',
  '🎉': '1f389',
  '🎊': '1f38a',
  '🎈': '1f388',
  '🎁': '1f381',
  '🎀': '1f380',
  '🎂': '1f382',
  '🍰': '1f370',
  '🧁': '1f9c1',
  '🍭': '1f36d',
  '🍬': '1f36c',
  '🍫': '1f36b',
  '🍩': '1f369',
  '🍪': '1f36a',
  '🥛': '1f95b',
  '☕': '2615',
  '🍵': '1f375',
  '🍺': '1f37a',
  '🍻': '1f37b',
  '🥂': '1f942',
  '🍷': '1f377',
  '🍾': '1f37e',
  '🍸': '1f378',
  '🍹': '1f379',
  '🍼': '1f37c',
  '🥃': '1f943',
  '🔥': '1f525',
  '💧': '1f4a7',
  '🌊': '1f30a',
  '❄️': '2744-fe0f',
  '⭐': '2b50',
  '🌟': '1f31f',
  '✨': '2728',
  '🌈': '1f308',
  '☀️': '2600-fe0f',
  '🌤️': '1f324-fe0f',
  '⛅': '26c5',
  '🌥️': '1f325-fe0f',
  '☁️': '2601-fe0f',
  '🌦️': '1f326-fe0f',
  '🌧️': '1f327-fe0f',
  '⛈️': '26c8-fe0f',
  '🌩️': '1f329-fe0f',
  '🌨️': '1f328-fe0f',
  '❤️': '2764-fe0f',
  '🧡': '1f9e1',
  '💛': '1f49b',
  '💚': '1f49a',
  '💙': '1f499',
  '💜': '1f49c',
  '🤍': '1f90d',
  '🖤': '1f5a4',
  '🤎': '1f90e',
  '💔': '1f494',
  '❣️': '2763-fe0f',
  '💕': '1f495',
  '💞': '1f49e',
  '💓': '1f493',
  '💗': '1f497',
  '💖': '1f496',
  '💘': '1f498',
  '💝': '1f49d',
  '💟': '1f49f',
  '🎯': '1f3af',
  '🎮': '1f3ae',
  '🕹️': '1f579-fe0f',
  '🎰': '1f3b0',
  '🎲': '1f3b2',
  '🧩': '1f9e9',
  '🧸': '1f9f8',
  '🎭': '1f3ad',
  '🎨': '1f3a8',
  '👓': '1f453',
  '🕶️': '1f576-fe0f',
  '👔': '1f454',
  '👕': '1f455',
  '👖': '1f456',
  '👗': '1f457',
  '👘': '1f458',
  '👙': '1f459',
  '👚': '1f45a',
  '👛': '1f45b',
  '👜': '1f45c',
  '👝': '1f45d',
  '🎒': '1f392',
  '👞': '1f45e',
  '👟': '1f45f',
  '👠': '1f460',
  '👡': '1f461',
  '👢': '1f462',
  '👑': '1f451',
  '👒': '1f452',
  '🎩': '1f3a9',
  '🎓': '1f393',
  '💄': '1f484',
  '💍': '1f48d',
  '💎': '1f48e',
  '🔇': '1f507',
  '🔈': '1f508',
  '🔉': '1f509',
  '🔊': '1f50a',
  '📢': '1f4e2',
  '📣': '1f4e3',
  '📯': '1f4ef',
  '🔔': '1f514',
  '🔕': '1f515',
  '🎼': '1f3bc',
  '🎵': '1f3b5',
  '🎶': '1f3b6',
  '🎤': '1f3a4',
  '🎧': '1f3a7',
  '📻': '1f4fb',
  '🎷': '1f3b7',
  '🎸': '1f3b8',
  '🎹': '1f3b9',
  '🎺': '1f3ba',
  '🎻': '1f3bb',
  '🥁': '1f941',
  '📱': '1f4f1',
  '📲': '1f4f2',
  '☎️': '260e-fe0f',
  '📞': '1f4de',
  '📟': '1f4df',
  '📠': '1f4e0',
  '🔋': '1f50b',
  '🔌': '1f50c',
  '💻': '1f4bb',
  '🖥️': '1f5a5-fe0f',
  '🖨️': '1f5a8-fe0f',
  '⌨️': '2328-fe0f',
  '🖱️': '1f5b1-fe0f',
  '💽': '1f4bd',
  '💾': '1f4be',
  '💿': '1f4bf',
  '📀': '1f4c0',
  '🎥': '1f3a5',
  '📽️': '1f4fd-fe0f',
  '🎬': '1f3ac',
  '📺': '1f4fa',
  '📷': '1f4f7',
  '📸': '1f4f8',
  '📹': '1f4f9',
  '📼': '1f4fc',
  '🔍': '1f50d',
  '🔎': '1f50e',
  '🕯️': '1f56f-fe0f',
  '💡': '1f4a1',
  '🔦': '1f526',
  '🏮': '1f3ee',
  '📔': '1f4d4',
  '📕': '1f4d5',
  '📖': '1f4d6',
  '📗': '1f4d7',
  '📘': '1f4d8',
  '📙': '1f4d9',
  '📚': '1f4da',
  '📓': '1f4d3',
  '📒': '1f4d2',
  '📃': '1f4c3',
  '📜': '1f4dc',
  '📄': '1f4c4',
  '📰': '1f4f0',
  '📑': '1f4d1',
  '🔖': '1f516',
  '💰': '1f4b0',
  '💴': '1f4b4',
  '💵': '1f4b5',
  '💶': '1f4b6',
  '💷': '1f4b7',
  '💸': '1f4b8',
  '💳': '1f4b3',
  '💹': '1f4b9',
  '✉️': '2709-fe0f',
  '📧': '1f4e7',
  '📨': '1f4e8',
  '📩': '1f4e9',
  '📤': '1f4e4',
  '📥': '1f4e5',
  '📦': '1f4e6',
  '📫': '1f4eb',
  '📪': '1f4ea',
  '📬': '1f4ec',
  '📭': '1f4ed',
  '📮': '1f4ee',
  '✏️': '270f-fe0f',
  '✒️': '2712-fe0f',
  '🖋️': '1f58b-fe0f',
  '🖊️': '1f58a-fe0f',
  '🖌️': '1f58c-fe0f',
  '🖍️': '1f58d-fe0f',
  '📝': '1f4dd',
  '💼': '1f4bc',
  '📁': '1f4c1',
  '📂': '1f4c2',
  '📅': '1f4c5',
  '📆': '1f4c6',
  '📇': '1f4c7',
  '📈': '1f4c8',
  '📉': '1f4c9',
  '📊': '1f4ca',
  '📋': '1f4cb',
  '📌': '1f4cc',
  '📍': '1f4cd',
  '📎': '1f4ce',
  '📏': '1f4cf',
  '📐': '1f4d0',
  '✂️': '2702-fe0f',
  '🔒': '1f512',
  '🔓': '1f513',
  '🔏': '1f50f',
  '🔐': '1f510',
  '🔑': '1f511',
  '🔨': '1f528',
  '⛏️': '26cf-fe0f',
  '⚒️': '2692-fe0f',
  '🛠️': '1f6e0-fe0f',
  '⚔️': '2694-fe0f',
  '🏹': '1f3f9',
  '🛡️': '1f6e1-fe0f',
  '🔧': '1f527',
  '🔩': '1f529',
  '⚙️': '2699-fe0f',
  '⚖️': '2696-fe0f',
  '🔗': '1f517',
  '⛓️': '26d3-fe0f',
  '⚗️': '2697-fe0f',
  '🧪': '1f9ea',
  '🧫': '1f9eb',
  '🧬': '1f9ec',
  '🔬': '1f52c',
  '🔭': '1f52d',
  '📡': '1f4e1',
  '💉': '1f489',
  '💊': '1f48a',
  '🚪': '1f6aa',
  '🚽': '1f6bd',
  '🚿': '1f6bf',
  '🛁': '1f6c1',
  '🛒': '1f6d2',
  '🚬': '1f6ac',
  '⚰️': '26b0-fe0f',
  '⚱️': '26b1-fe0f',
  '🗿': '1f5ff',
  '🏧': '1f3e7',
  '🚮': '1f6ae',
  '🚰': '1f6b0',
  '♿': '267f',
  '🚹': '1f6b9',
  '🚺': '1f6ba',
  '🚻': '1f6bb',
  '🚼': '1f6bc',
  '🚾': '1f6be',
  '🛂': '1f6c2',
  '🛃': '1f6c3',
  '🛄': '1f6c4',
  '🛅': '1f6c5',
  '⚠️': '26a0-fe0f',
  '🚸': '1f6b8',
  '⛔': '26d4',
  '🚫': '1f6ab',
  '🚳': '1f6b3',
  '🚭': '1f6ad',
  '🚯': '1f6af',
  '🚱': '1f6b1',
  '🚷': '1f6b7',
  '📵': '1f4f5',
  '🔞': '1f51e',
  '☢️': '2622-fe0f',
  '☣️': '2623-fe0f',
  '⬆️': '2b06-fe0f',
  '↗️': '2197-fe0f',
  '➡️': '27a1-fe0f',
  '↘️': '2198-fe0f',
  '⬇️': '2b07-fe0f',
  '↙️': '2199-fe0f',
  '⬅️': '2b05-fe0f',
  '↖️': '2196-fe0f',
  '↕️': '2195-fe0f',
  '↔️': '2194-fe0f',
  '↩️': '21a9-fe0f',
  '↪️': '21aa-fe0f',
  '⤴️': '2934-fe0f',
  '⤵️': '2935-fe0f',
  '🔃': '1f503',
  '🔄': '1f504',
  '🔙': '1f519',
  '🔚': '1f51a',
  '🔛': '1f51b',
  '🔜': '1f51c',
  '🔝': '1f51d',
  '🔀': '1f500',
  '🔁': '1f501',
  '🔂': '1f502',
  '▶️': '25b6-fe0f',
  '⏩': '23e9',
  '⏭️': '23ed-fe0f',
  '⏯️': '23ef-fe0f',
  '◀️': '25c0-fe0f',
  '⏪': '23ea',
  '⏮️': '23ee-fe0f',
  '🔼': '1f53c',
  '⏫': '23eb',
  '🔽': '1f53d',
  '⏬': '23ec',
  '⏸️': '23f8-fe0f',
  '⏹️': '23f9-fe0f',
  '⏺️': '23fa-fe0f',
  '⏏️': '23cf-fe0f',
  '🎦': '1f3a6',
  '🔅': '1f505',
  '🔆': '1f506',
  '📶': '1f4f6',
  '📳': '1f4f3',
  '📴': '1f4f4',
  '✖️': '2716-fe0f',
  '➕': '2795',
  '➖': '2796',
  '➗': '2797',
  '♾️': '267e-fe0f',
  '‼️': '203c-fe0f',
  '⁉️': '2049-fe0f',
  '❓': '2753',
  '❔': '2754',
  '❕': '2755',
  '❗': '2757',
  '〰️': '3030-fe0f',
  '💱': '1f4b1',
  '💲': '1f4b2',
  '⚕️': '2695-fe0f',
  '♻️': '267b-fe0f',
  '⚜️': '269c-fe0f',
  '🔱': '1f531',
  '📛': '1f4db',
  '🔰': '1f530',
  '⭕': '2b55',
  '✅': '2705',
  '☑️': '2611-fe0f',
  '✔️': '2714-fe0f',
  '❌': '274c',
  '❎': '274e',
  '➰': '27b0',
  '➿': '27bf',
  '〽️': '303d-fe0f',
  '✳️': '2733-fe0f',
  '✴️': '2734-fe0f',
  '❇️': '2747-fe0f',
  '©️': '00a9-fe0f',
  '®️': '00ae-fe0f',
  '™️': '2122-fe0f',
  '🔟': '1f51f',
  '🔠': '1f520',
  '🔡': '1f521',
  '🔢': '1f522',
  '🔣': '1f523',
  '🔤': '1f524',
  '🅰️': '1f170-fe0f',
  '🆎': '1f18e',
  '🅱️': '1f171-fe0f',
  '🆑': '1f191',
  '🆒': '1f192',
  '🆓': '1f193',
  'ℹ️': '2139-fe0f',
  '🆔': '1f194',
  'Ⓜ️': '24c2-fe0f',
  '🆕': '1f195',
  '🆖': '1f196',
  '🅾️': '1f17e-fe0f',
  '🆗': '1f197',
  '🅿️': '1f17f-fe0f',
  '🆘': '1f198',
  '🆙': '1f199',
  '🆚': '1f19a',
  '🔴': '1f534',
  '🟠': '1f7e0',
  '🟡': '1f7e1',
  '🟢': '1f7e2',
  '🔵': '1f535',
  '🟣': '1f7e3',
  '🟤': '1f7e4',
  '⚫': '26ab',
  '⚪': '26aa',
  '🟥': '1f7e5',
  '🟧': '1f7e7',
  '🟨': '1f7e8',
  '🟩': '1f7e9',
  '🟦': '1f7ea',
  '🟪': '1f7eb',
  '🟫': '1f7ec',
  '⬛': '2b1b',
  '⬜': '2b1c',
  '◼️': '25fc-fe0f',
  '◻️': '25fb-fe0f',
  '◾': '25fe',
  '◽': '25fd',
  '▪️': '25aa-fe0f',
  '▫️': '25ab-fe0f',
  '🔶': '1f536',
  '🔷': '1f537',
  '🔸': '1f538',
  '🔹': '1f539',
  '🔺': '1f53a',
  '🔻': '1f53b',
  '💠': '1f4a0',
  '🔘': '1f518',
  '🔳': '1f533',
  '🔲': '1f532',
  '🏁': '1f3c1',
  '🚩': '1f6a9',
  '🎌': '1f38c',
  '🏴': '1f3f4',
  '🏳️': '1f3f3-fe0f',
  '👍': '1f44d',
  '👎': '1f44e',
  '👌': '1f44c',
  '✌️': '270c-fe0f',
  '🤞': '1f91e',
  '🤟': '1f91f',
  '🤘': '1f918',
  '🤙': '1f919',
  '👈': '1f448',
  '👉': '1f449',
  '👆': '1f446',
  '👇': '1f447',
  '☝️': '261d-fe0f',
  '✋': '270b',
  '🤚': '1f91a',
  '🖐️': '1f590-fe0f',
  '🖖': '1f596',
  '👋': '1f44b',
  '🤝': '1f91d',
  '🙏': '1f64f',
  '💪': '1f4aa',
  '🦾': '1f9be',
  '🦿': '1f9bf',
  '🦵': '1f9b5',
  '🦶': '1f9b6',
  '👂': '1f442',
  '🦻': '1f9bb',
  '👃': '1f443',
  '🧠': '1f9e0',
  '🫀': '1fac0',
  '🫁': '1fac1',
  '🦷': '1f9b7',
  '🦴': '1f9b4',
  '👀': '1f440',
  '👁️': '1f441-fe0f',
  '👅': '1f445',
  '👄': '1f444'
}

const baseUrl = 'https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/72x72/'
const emojiDir = path.join(__dirname, '..', 'src', 'assets', 'emojis')

// 创建emoji目录
if (!fs.existsSync(emojiDir)) {
  fs.mkdirSync(emojiDir, { recursive: true })
}

console.log(`🚀 开始下载 ${Object.keys(emojiMap).length} 个emoji图片...`)

let downloadedCount = 0
let failedCount = 0
const totalCount = Object.keys(emojiMap).length

function downloadEmoji(emoji, unicode) {
  return new Promise((resolve, reject) => {
    const url = `${baseUrl}${unicode}.png`
    const filepath = path.join(emojiDir, `${unicode}.png`)
    
    // 如果文件已存在，跳过
    if (fs.existsSync(filepath)) {
      console.log(`⏭️  ${emoji} (${unicode}) 已存在，跳过`)
      downloadedCount++
      resolve()
      return
    }
    
    const file = fs.createWriteStream(filepath)
    
    https.get(url, (response) => {
      if (response.statusCode !== 200) {
        console.log(`❌ ${emoji} (${unicode}) 下载失败: HTTP ${response.statusCode}`)
        failedCount++
        file.close()
        fs.unlink(filepath, () => {}) // 删除失败的文件
        resolve()
        return
      }
      
      response.pipe(file)
      
      file.on('finish', () => {
        file.close()
        console.log(`✅ ${emoji} (${unicode}) 下载成功`)
        downloadedCount++
        resolve()
      })
      
      file.on('error', (err) => {
        console.log(`❌ ${emoji} (${unicode}) 写入失败:`, err.message)
        failedCount++
        file.close()
        fs.unlink(filepath, () => {}) // 删除失败的文件
        resolve()
      })
    }).on('error', (err) => {
      console.log(`❌ ${emoji} (${unicode}) 网络错误:`, err.message)
      failedCount++
      file.close()
      fs.unlink(filepath, () => {}) // 删除失败的文件
      resolve()
    })
  })
}

async function downloadAllEmojis() {
  const promises = []
  
  for (const [emoji, unicode] of Object.entries(emojiMap)) {
    promises.push(downloadEmoji(emoji, unicode))
    
    // 每10个并发下载，避免过多请求
    if (promises.length >= 10) {
      await Promise.all(promises)
      promises.length = 0
      
      // 显示进度
      const progress = Math.round((downloadedCount + failedCount) / totalCount * 100)
      console.log(`📊 进度: ${downloadedCount + failedCount}/${totalCount} (${progress}%)`)
      
      // 间隔一下，避免请求过快
      await new Promise(resolve => setTimeout(resolve, 500))
    }
  }
  
  // 处理剩余的
  if (promises.length > 0) {
    await Promise.all(promises)
  }
  
  console.log(`\n🎉 emoji图片下载完成！`)
  console.log(`✅ 成功: ${downloadedCount} 个`)
  console.log(`❌ 失败: ${failedCount} 个`)
  console.log(`📁 保存路径: ${emojiDir}`)
}

downloadAllEmojis().catch(console.error) 